# MySQL/MariaDB Swap Usage

## 이 주제를 공부하는 이유
- AWS RDS Instance 중에 다운그레이드 할 수 있는 여력이 있는 것들이 있는지 조사해보는 과정에서 `Swap` 이라는 메트릭이 굉장히 중요하다는 것을 알게 됨
- 이전에 Swap 이라는 단어는 들어보기는 했으나 정확한 정의에 대해 알지 못한 상태였고 특히 RDBMS의 Swap이 기술적으로 어떤 의미를 갖고 있는지 이번에 알아보고자 함

## 배운 내용

### 1. Swap이란? (한 문장으로)
Swap Usage는 물리 메모리가 부족할 때, 운영체제가 디스크 공간을 임시적으로 점유하여 임시 메모리처럼 사용하는 것을 의미합니다. RDBMS에서는 치명적인 성능 저하를 암시합니다.

### 2. 왜 Swap이 생기나? (원인)
DB는 Query를 실행하면서 실제 Disk I/O에서 데이터를 읽어와서 작업 공간 메모리에 적재합니다. 이 작업 공간 메모리에서 작업을 수행하는 과정에서 메모리 여유분이 부족한 상황이 발생하게 되는 경우, OS가 메모리 부족분을 계산하여 특정 사이즈만큼 Swap Out 하는 작업을 수행합니다. 이 Swap Out 상황이 발생하게 되면 메모리 부족분 만큼을 디스크에 적재하게 됩니다.

### 3. MySQL에서 왜 특히 문제인가?
MySQL(MariaDB) 프로세스는 Swap Out 상황을 인지할 수 없습니다. 따라서 평소와 같이 작업을 진행하고 특정 메모리 참조를 하게 되면 이를 OS에 요청하게 됩니다. OS는 이 요청을 받고 참조하려는 메모리를 뒤져서 이것이 메모리 영역이 아닌 디스크 영역에 있다고 판단하는 경우 하드웨어 인터럽트를 발생시키고 직접 디스크에서 데이터를 가져오려고 시도합니다. 이로인해 평소와 달리 MySQL 프로세스는 매우 장시간 대기해야 하지만 그 이유는 알지 못합니다. 마침내 OS가 디스크 영역에서 데이터를 가져와 MySQL 프로세스에 전달하고 프로세스는 작업을 계속 진행합니다.

### 4. MySQL 메모리 구조
- Buffer Pool: MySQL은 모든 작업을 디스크에서 직접 수행하지 않고 중간 Cache 성격의 Buffer Pool Memory를 운영합니다. 디스크의 테이블/인덱스 데이터를 캐시하는 것입니다. 이것은 '캐시'이므로 원본 데이터는 디스크에 있습니다. 따라서 이론적으로는 버릴 수도 있지만 OS가 강제로 Swap Out 할 수도 있습니다. 일반적으로 전체 메모리의 3/4 정도를 Buffer Pool로 설정합니다.
- sort_buffer_size: `sort by`, `group by` query를 처리하는 데 사용할 메모리 영역 사이즈를 말합니다. 기본값은 256KB입니다. 이 값을 과도하게 키우는 경우 Swap 발생 가능성이 높아집니다. 참고로 이 사이즈는 세션당 사이즈를 말합니다. 만약 이 값을 초과하는 정렬 작업이 발생하게 되는 경우 디스크 임시 파일을 사용합니다 (External Sort) 그러나 이것이 Swap을 의미하는 것은 아닙니다. MySQL이 의도적으로 제어하는 동작인 것입니다.
- join_buffer_size: `Table Join`을 처리하는데 사용하는 메모리 영역 사이즈를 말합니다. 기본값은 256KB입니다. 이 값을 과도하게 키우는 경우 Swap 발생 가능성이 높아집니다. 참고로 이 사이즈는 세션당 사이즈를 말합니다.

### 5. 어떻게 확인하나? (명령어)
`free -h`, `vmstat 1 10` 등의 명령어로 swap이 발생했는지 발생했다면 어느 정도 크기로 발생했는지 파악할 수 있습니다.

### 6. 어떻게 해결하나?
  - 즉시 대응
    - swapoff -a && swapon -a (Swap 제거)
    - 느린 쿼리 종료
  - 설정 조정 (메모리 늘리기 전):
    - Buffer Pool 크기 감소 (75% → 60%)
    - 세션별 버퍼 기본값으로 (256KB)
    - vm.swappiness=1 설정
  - 근본 해결:
    - 메모리 추가 (최종 수단)
    - 쿼리 최적화, 인덱스 추가

### 7. 예방 방법은?
  - 테이블에 자주 사용되는 컬럼에 대해서 인덱스 설정을 꼼꼼하게 해야 합니다.
  - `swap` metric을 주기적으로 모니터링 하고 특정 값 이상 상황이 발생하면 알람(이메일, Slack noti)을 발생시키게끔 설정해야 합니다.

### 8. 실제 사례 하나
  - 총 메모리: 32GB
  - Buffer Pool: 24GB
  - soft_buffer_size:30MB
  - join_buffer_size:30MB
  - max connection size: 200
  => 사용자가 많아져서 동시 쿼리 (sort by, join)이 많아짐
  => Buffer Pool(24GB) + (soft_buffer_sizex200) + (join_buffer_sizex200) = 24GB+6GB+6GB = 36GB
  => OS가 메모리 부족 상황으로 판단하여 Swap Out 발생


### 총 메모리 사용 계산 공식
```
총 메모리 사용 = 
  InnoDB Buffer Pool
  + (sort_buffer_size × 동시 정렬 세션 수)
  + (join_buffer_size × 동시 JOIN 세션 수)
  + (기타 세션별 버퍼 × 세션 수)
  + OS 메모리
  + 기타
```